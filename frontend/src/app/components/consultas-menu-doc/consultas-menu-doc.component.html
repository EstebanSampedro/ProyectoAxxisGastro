<app-main-header></app-main-header>
<app-nav-bar></app-nav-bar>

<!-- Encabezado del Doctor -->
<div class="header-doc">
  <h1>{{ doctorName }}</h1>
</div>

<div class="container">
  <div class="flex-row">
    <div class="flex-column">
      <app-date-picker
        (dateChange)="onPickerDateChange($event)">
      </app-date-picker>
    </div>
    <div class="flex-column">
      <div class="action-icons">
        <button class="btn icon-btn" title="Buscar" (click)="onDateChange()">
          Buscar 
          <fa-icon [icon]="faSearch"></fa-icon>
        </button>
      </div>
    </div>
  </div>
</div>
<div class="observaciones-section container">
  <!-- Ahora SIEMPRE aparece -->
<button class="btn icon-btn" title="Ver observaciones" (click)="verObservaciones()">
  <fa-icon [icon]="faWarning"></fa-icon>
</button>
  <label for="observaciones">OBSERVACIONES:</label>
  <textarea
    id="observaciones"
    rows="2"
    [(ngModel)]="observaciones"
    class="responsive-textarea"
  ></textarea>
  <button (click)="guardarObservaciones()" class="btn">Guardar
    <fa-icon [icon]="faSave">
    </fa-icon>
  </button>
</div>


<!-- Tabla de Consultas -->
<table class="consultas-table">
  <thead>
    <tr>
      <th>HORA</th>
      <th>HORA FIN</th>
      <th>CEDULA</th>
      <th>PACIENTE</th>
      <th>TEL√âFONO</th>
      <th>SEGURO</th>
      <th>OBSERVACIONES</th>
      <th>COLOR</th>
      <th>CONF.</th>
      <th>RESP.</th>
      <th>OPCIONES</th>
    </tr>
  </thead>
  <!-- Se agrega cdkDropList al tbody -->
  <tbody cdkDropList (cdkDropListDropped)="drop($event)">
    <!-- Cada fila es draggable y se le asigna el dato de la cita (si existe) -->
    <tr *ngFor="let slot of timeSlots"
      cdkDrag
      [cdkDragDisabled]="getCitaBySlot(slot)?.tipoCita === 'cita'"
        [ngStyle]="{ 'background-color': getCitaBySlot(slot)?.colorCita || '' }">
      <!-- Columna 1: HORA -->
      <td>{{ slot }}</td>
      
      <!-- Verificamos si existe una cita en este slot -->
      <ng-container *ngIf="getCitaBySlot(slot) as cita; else sinCita">
        <!-- MODO EDICI√ìN DE CITA EXISTENTE -->
        <ng-container *ngIf="editingCitaId === cita.idCita; else modoLectura">
          <!-- Inputs en l√≠nea para edici√≥n -->
          <td>
            <input type="text" [(ngModel)]="newCitaData.horaTermina" placeholder="HH:mm:00" />
          </td>
          <td>
            <input type="text" [(ngModel)]="newCitaData.cedula" placeholder="Cedula" />
          </td>
          <td>
            <input type="text" [(ngModel)]="newCitaData.paciente" placeholder="Paciente" />
          </td>
          <td>
            <input type="text" [(ngModel)]="newCitaData.telefono" placeholder="Tel√©fono" />
          </td>
          <td>
            <input type="text" [(ngModel)]="newCitaData.seguro" placeholder="Seguro" />
          </td>
          <td>
            <input type="text" [(ngModel)]="newCitaData.observaciones" placeholder="Observaciones" />
          </td>
          <td>
            <select [(ngModel)]="newCitaData.colorCita">
              <option value="#FFFFFF">Ninguno</option>
              <option value="#ffff00">Amarillo</option>
              <option value="#ff0000">Rojo</option>
              <option value="#0000ff">Azul</option>
              <option value="#FEBB02">Naranja</option>
              <option value="#00ff00">Verde</option>
              <option value="#8080c0">Gris</option>
            </select>
          </td>
          <td>
            <input type="text" [(ngModel)]="newCitaData.confirmado" disabled />
          </td>
          <td>
            <input type="text" [(ngModel)]="newCitaData.codigoMedico" disabled />
          </td>
          <td>
            <div class="horizontal-btns">
              <button
                class="btn-save"
                title="Guardar cambios"
                (click)="guardarEdicion()">
                <fa-icon [icon]="faSaveAlt"></fa-icon>
              </button>
              <button
                title="Cancelar edici√≥n"
                (click)="cancelarEdicion()">
                <fa-icon [icon]="faCancelAlt"></fa-icon>
              </button>
              <button title="Reagendar cita" (click)="openRescheduleModal(cita, slot)">
                <fa-icon [icon]="faCalendarAlt"></fa-icon>
              </button>
            </div>
          </td>
        </ng-container>
        <!-- MODO LECTURA DE CITA EXISTENTE -->
        <ng-template #modoLectura>
          <td>{{ cita.horaFinStr }}</td>
          <td>{{ cita.cedula }}</td>
          <td>{{ cita.paciente }}</td>
          <td>{{ cita.telefono }}</td>
          <td>{{ cita.seguro }}</td>
          <td>{{ cita.observaciones }}</td>
          <td>{{ colorNames[cita.colorCita] || cita.colorCita }}</td>
          <td>{{ cita.confirmado }}</td>
          <td>{{ cita.responsable }}</td>
          <td>
            <div *ngIf="cita.tipoCita === 'consulta'" class="horizontal-btns">
              <button (click)="enviarWhatsApp(cita)">üìû</button>
              <button (click)="enviarRecordatorio(cita)">üîî</button>
              <button (click)="confirmarCita(cita)">‚úî</button>
              <button (click)="editarConsulta(cita)">‚úèÔ∏è</button>
              <button (click)="eliminarConsulta(cita)">‚ùå</button>
            </div>
          </td>
        </ng-template>
      </ng-container>
      
      <!-- SIN CITA (slot vac√≠o) -->
      <ng-template #sinCita>
        <ng-container *ngIf="editingSlot === slot; else modoVacio">
          <!-- Formulario de creaci√≥n en la misma fila -->
          <td>
            <span class="placeholder-text">--:--</span>
          </td>
          <td>
            <input type="text" [(ngModel)]="newCitaData.cedula" placeholder="Cedula" />
          </td>
          <td>
            <input type="text" [(ngModel)]="newCitaData.paciente" placeholder="Paciente" />
          </td>
          <td>
            <input type="text" [(ngModel)]="newCitaData.telefono" placeholder="Tel√©fono" />
          </td>
          <td>
            <input type="text" [(ngModel)]="newCitaData.seguro" placeholder="Seguro" />
          </td>
          <td>
            <input type="text" [(ngModel)]="newCitaData.observaciones" placeholder="Observaciones" />
          </td>
          <td>
            <select [(ngModel)]="newCitaData.colorCita">
              <option value="#FFFFFF">Ninguno</option>
              <option value="#ffff00">Amarillo</option>
              <option value="#ff0000">Rojo</option>
              <option value="#0000ff">Azul</option>
              <option value="#FEBB02">Naranja</option>
              <option value="#00ff00">Verde</option>
              <option value="#8080c0">Gris</option>
            </select>
          </td>
          <td>
            <span class="placeholder-text">pendiente</span>
          </td>
          <td>
            <span class="placeholder-text"></span>
          </td>
          <td>
            <div class="horizontal-btns">
              <button (click)="guardarCita(slot)">Guardar</button>
              <button (click)="cancelarCita()">Cancelar</button>
            </div>
          </td>
        </ng-container>
        <ng-template #modoVacio>
          <td><span class="placeholder-text">--:--</span></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td><span class="placeholder-text">pendiente</span></td>
          <td></td>
          <td>
            <button class="plus-btn" (click)="iniciarCita(slot)">‚ûï</button>
          </td>
        </ng-template>
      </ng-template>
    </tr>
  </tbody>
</table>


<!-- Modal de Confirmaci√≥n -->
<div *ngIf="showConfirmModal" class="modal-overlay">
  <div class="modal">
    <h3>Confirmar cita para {{ citaToConfirm?.paciente }}</h3>
    <p>Seleccione una opci√≥n:</p>
    <div class="modal-buttons">
      <!-- Bot√≥n Confirmar (SI) -->
      <button class="btn-confirm" (click)="handleConfirmOption('si')">
        Confirmar (SI)
      </button>

      <!-- Bot√≥n Denegar (NO) -->
      <button class="btn-deny" (click)="handleConfirmOption('no')">
        Denegar (NO)
      </button>

      <!-- Bot√≥n Pendiente -->
      <button class="btn-pending" (click)="handleConfirmOption('pendiente')">
        Pendiente
      </button>

      <!-- Bot√≥n Cancelar -->
      <button class="btn-cancel" (click)="handleConfirmOption('cancelar')">
        Cancelar
      </button>
    </div>
  </div>
</div>


<!-- Modal de Reagendar -->
<div *ngIf="showRescheduleModal" class="modal-overlay">
  <div class="modal reschedule-modal">
    <h3>Reagendar cita de {{ citaToReschedule.paciente }}</h3>

    <table style="margin:0 auto; text-align:left">
      <tr><td><b>Fecha actual:</b></td><td>{{ citaToReschedule.fecha }}</td></tr>
      <tr><td><b>Hora actual:</b></td><td>{{ citaToReschedule.horaStr }}</td></tr>
      <tr><td><b>Torre actual:</b></td><td>{{ citaToReschedule.torre }}</td></tr>
      <tr><td><b>Doctor:</b></td>
          <td>{{ doctorName  }}</td></tr>
      <tr><td><b>Procedimiento:</b></td>
          <td>{{ citaToReschedule.procedimiento }}</td></tr>
    </table>

    <div class="filtros" style="justify-content:center; margin-top:1rem">

      <label>Fecha:</label>
      <input type="date" [(ngModel)]="rescheduleDate" />

      <label>Hora:</label>
      <select [(ngModel)]="rescheduleHour">
        <option *ngFor="let h of timeSlots" [value]="h">{{ h }}</option>
      </select>
    </div>

    <div class="modal-buttons" style="margin-top:1rem">
      <button class="btn-submit" (click)="rescheduleCita()">Reagendar</button>
      <button class="btn-cancel"  (click)="closeRescheduleModal()">Cancelar</button>
    </div>
  </div>
</div>
